package ai.promethean.API;
import ai.promethean.ExecutingAgent.*;
import ai.promethean.Output.*;
import ai.promethean.Parser.*;
import ai.promethean.Logger.*;

import java.util.List;
import java.util.Map;

import ai.promethean.DataModel.*;
import ai.promethean.Planner.*;


/*
    This API is meant to be as simple as possible and expandable as possible.
    If you want to add a new functionality simply add a function to the the API class.
    PlannerError is a custom error throwing class. When throwing a PlannerError make sure to include
    a detailed error message.
    Example, if we want to add a function to create resource objects, simply create that function and then
    call it with the resource object that keeps track of the examples
*/

public class API {
    private String className = this.getClass().getSimpleName();

    public API(){

    }
    public void throwPlannerError(String err_msg){
        PlannerError e = new PlannerError(err_msg);
        Logger.logError(e, className);
        throw e;
    }

    public void throwParserError(String err_msg){
        ParserError e = new ParserError(err_msg);
        Logger.logError(e, className);
        throw e;
    }
    public void throwOutputError(String err_msg){
        OutputError e = new OutputError(err_msg);
        Logger.logError(e, className);
        throw e;
    }

    public void throwCLIError(String err_msg){
        CLIError e = new CLIError(err_msg);
        Logger.logError(e, className);
        throw e;
    }


    public Map<String, Object> parseInput(String inputFile, boolean isFile){
        ParserInterface p = new JSONParser();
        Map<String, Object> objects = p.parse(inputFile, isFile);

        return objects;
    }

    /**
     * Generate a plan to be used by planner from list of parsed objects
     * @param parsedObjects List of objects generated by parser
     */
    public Plan generatePlanFromParsedObjects(Map<String, Object> parsedObjects, double stopTime, boolean activateCLF){
        Algorithm algo = new AStar();
        Planner planner = new Planner(algo);
        Plan plan = planner.plan((SystemState) parsedObjects.get("initialState"),
                (GoalState) parsedObjects.get("goalState"),
                (TaskDictionary) parsedObjects.get("tasks"),
                (StaticOptimizations) parsedObjects.get("optimizations"),
                stopTime,
                activateCLF);
        return plan;
    }

    /**
     * This is an overloaded function for the user to store a JSON file of the plan
     * Generate a plan to be used by planner from list of parsed objects
     * @param parsedObjects List of objects generated by parser
     */
    public Plan generatePlanFromParsedObjects(Map<String, Object> parsedObjects, String outputFileDir, double stopTime, boolean activateCLF) {
        Plan plan= generatePlanFromParsedObjects(parsedObjects, stopTime, activateCLF);
        JSONOutput.writeToFile(plan, outputFileDir, "Plan");
        return plan;
    }

    /**
     * Parses the JSON language input and builds a plan
     * @param inputFile: Input File path or raw JSON string
     * @param isFile: Boolean denoting whether inputFile is a file path or raw JSON
     * @return Generated plan
     */
    public Plan generatePlanFromJSON(String inputFile, Boolean isFile, double stopTime, boolean activateCLF){
        Map<String, Object> parsedObjects= parseInput(inputFile,isFile);
        return generatePlanFromParsedObjects(parsedObjects, stopTime, activateCLF);
    }

    /**
     * This is an overloaded function for the user to store a JSON file of the plan
     * Parses the JSON language input and builds a plan
     * @param inputFile: Input File path or raw JSON string
     * @param isFile: Boolean denoting whether inputFile is a file path or raw JSON
     * @param outputFileDir: Directory to store the Plan output file
     * @return Generated plan
     */
    public Plan generatePlanFromJSON(String inputFile, Boolean isFile, String outputFileDir, double stopTime, boolean activateCLF){
        Plan plan= generatePlanFromJSON(inputFile,isFile, stopTime, activateCLF);
        JSONOutput.writeToFile(plan, outputFileDir, "Plan");
        return plan;
    }

    /**
     * Generate a plan from a specific SystemState Object instead of list of parsed objects
     * @param currentState
     * @param goalState
     * @param taskDictionary
     * @param optimizations
     * @return
     */
    public Plan generatePlanFromSystemState(SystemState currentState,
                                            GoalState goalState,
                                            TaskDictionary taskDictionary,
                                            StaticOptimizations optimizations,
                                            double stopTime,
                                            boolean activateCLF){
        Algorithm algo = new AStar();
        Planner planner = new Planner(algo);
        Plan plan = planner.plan(currentState, goalState, taskDictionary, optimizations, stopTime, activateCLF);
        return plan;
    }


    public List<SystemState> executeExistingPlan(Plan plan, Map<String, Object> parsedObjects, double stopTime, boolean activateCLF){
        ExecutionManager exeManager = new ExecutionManager();
        return exeManager.runPlanClock(plan, parsedObjects, stopTime, activateCLF);
    }

    /**
     * Parse the input file and generate a plan from the parsed objects.
     * Initialize the clock and handle perturbation or goal state responses
     */
    public List<SystemState> executePlan(String input, Boolean isFile, String outputPlanPath, String outputStatesPath, double stopTime, boolean activateCLF){
        Map <String, Object> objects = parseInput(input, isFile);
        Plan plan = generatePlanFromParsedObjects(objects,outputPlanPath, stopTime, activateCLF);
        List<SystemState> executedStates = executeExistingPlan(plan,objects, stopTime, activateCLF);
        JSONOutput.writeToFile(executedStates,outputStatesPath, "SystemState");
        return executedStates;
    }

    /**
     * Parse the input file and generate a plan from the parsed objects.
     * Initialize the clock and handle perturbation or goal state responses
     */
    public List<SystemState> executePlan(String input, Boolean isFile, double stopTime, boolean activateCLF){
        Map <String, Object> objects = parseInput(input, isFile);
        Plan plan = generatePlanFromParsedObjects(objects, stopTime, activateCLF);
        List<SystemState> executedStates = executeExistingPlan(plan,objects, stopTime, activateCLF);
        return executedStates;
    }
}

